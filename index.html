<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BNOTES - Shared Note Taking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {},
            },
            safelist: [
                'tag-work',
                'tag-personal',
                'tag-ideas',
                'tag-important',
                'tag-study',
                'tag-cuisine', /* Exemple de tag personnalis√© */
            ]
        }
    </script>
    
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* Animation for note cards */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .note-card {
            animation: fadeIn 0.3s ease-out forwards;
        }
        
        /* Tag colors - utilis√©s pour les cartes de notes */
        .tag-work { background-color: #FFD700; }
        .tag-personal { background-color: #90EE90; }
        .tag-ideas { background-color: #ADD8E6; }
        .tag-important { background-color: #FFA07A; }
        .tag-study { background-color: #D8BFD8; }

        /* Styles for the new Content Editable Editor */
        #noteContentEditor {
            min-height: 200px;
            border: 1px solid #e5e7eb; /* gray-200 */
            padding: 1rem;
            border-radius: 0.375rem; /* rounded-md */
            line-height: 1.5;
            overflow-y: auto;
            /* Emp√™che les images ins√©r√©es de devenir trop grandes */
            word-wrap: break-word;
        }
        
        /* Style pour les √©l√©ments m√©dia ins√©r√©s */
        #noteContentEditor img,
        #noteContentEditor video,
        #noteContentEditor audio {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 10px auto;
            border-radius: 5px;
        }

        #noteContentEditor a {
            color: #3b82f6; /* blue-500 */
            text-decoration: underline;
        }
        
        /* Styles pour la nouvelle barre d'outils de formatage */
        #fontColorPicker {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-color: transparent;
            border: none;
            cursor: pointer;
            padding: 0;
            margin: 0;
            vertical-align: middle;
        }
        #fontColorPicker::-webkit-color-swatch {
            border: none;
            border-radius: 50%;
        }
        #fontColorPicker::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        #formattingToolbar button, 
        #formattingToolbar select {
            /* S'assurer que les boutons ne sont pas trop grands */
            min-height: 30px; 
            line-height: 1;
        }

    </style>
</head>
<body class="bg-gray-100 font-sans">
    <header class="bg-white shadow-sm sticky top-0 z-10">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fas fa-sticky-note text-green-500 text-2xl"></i>
                <h1 class="text-xl font-bold text-gray-800">BNOTES</h1>
            </div>
            <div class="flex items-center space-x-4">
                <div class="relative">
                    <input type="text" placeholder="Search notes..." class="pl-10 pr-4 py-2 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    <i class="fas fa-search absolute left-3 top-2.5 text-gray-400"></i>
                </div>
                <div id="authContainer">
                    <div id="signInButton">
                        <button class="bg-blue-700 hover:bg-blue-800 text-white px-4 py-2 rounded-lg flex items-center space-x-2">
                            <i class="fab fa-facebook-f"></i> <span>Sign in with Facebook</span>
                        </button>
                    </div>
                    <div id="signedInContainer" class="relative group hidden">
                        <img id="userPhoto" src="https://via.placeholder.com/40" alt="Profile" class="w-10 h-10 rounded-full cursor-pointer">
                        <div class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 hidden group-hover:block">
                            <div class="px-4 py-2 text-gray-800 font-medium" id="userName">User Name</div>
                            <a href="#" class="block px-4 py-2 text-gray-800 hover:bg-gray-100">Profile</a>
                            <a href="#" class="block px-4 py-2 text-gray-800 hover:bg-gray-100">Settings</a>
                            <a href="#" id="signOutButton" class="block px-4 py-2 text-gray-800 hover:bg-gray-100">Sign out</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-6 flex flex-col md:flex-row">
        <aside class="w-full md:w-64 mb-6 md:mb-0 md:mr-6">
            <div class="bg-white rounded-lg shadow p-4">
                <button id="createNoteBtn" class="fixed bottom-6 right-6 md:relative md:bottom-auto md:right-auto w-14 h-14 md:w-full md:h-auto md:py-2 md:px-4 bg-green-500 hover:bg-green-600 text-white rounded-full md:rounded-lg flex items-center justify-center mb-4 transition duration-200 shadow-lg">
                    <i class="fas fa-plus text-xl md:text-base"></i>
                    <span class="hidden md:inline ml-2">New Note</span>
                </button>
                
                <div class="space-y-1">
                    <a href="#" class="sidebar-link flex items-center px-3 py-2 text-gray-700 rounded-lg bg-gray-100" data-filter="all">
                        <i class="fas fa-home mr-3 text-gray-500"></i> All Notes
                    </a>
                    <a href="#" class="sidebar-link flex items-center px-3 py-2 text-gray-700 rounded-lg hover:bg-gray-100" data-filter="starred">
                        <i class="fas fa-star mr-3 text-yellow-500"></i> Starred
                    </a>
                    <a href="#" class="sidebar-link flex items-center px-3 py-2 text-gray-700 rounded-lg hover:bg-gray-100" data-filter="shared">
                        <i class="fas fa-users mr-3 text-blue-500"></i> Shared with me
                    </a>
                    <a href="#" class="sidebar-link flex items-center px-3 py-2 text-gray-700 rounded-lg hover:bg-gray-100" data-filter="public">
                        <i class="fas fa-globe mr-3 text-green-500"></i> Public Notes
                    </a>
                    <a href="#" id="trashLink" class="sidebar-link flex items-center px-3 py-2 text-gray-700 rounded-lg hover:bg-gray-100" data-filter="trash">
                        <i class="fas fa-trash mr-3 text-red-500"></i> Trash
                    </a>
                </div>
                
                <div class="mt-6">
                    <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Tags</h3>
                    <div class="space-y-1" id="tagsList">
                    </div>
                </div>
            </div>
        </aside>

        <main class="flex-1">
            <div class="mb-6 flex justify-between items-center">
                <h2 class="text-xl font-semibold text-gray-800" id="pageTitle">My Notes</h2>
                <div class="flex space-x-2">
                    <button id="gridViewBtn" class="p-2 rounded-full hover:bg-gray-200 bg-gray-200">
                        <i class="fas fa-th-large text-gray-600"></i>
                    </button>
                    <button id="listViewBtn" class="p-2 rounded-full hover:bg-gray-200">
                        <i class="fas fa-list text-gray-600"></i>
                    </button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4" id="notesGrid">
                </div>
        </main>
    </div>

    <template id="noteTemplate">
        <div class="note-card bg-white rounded-lg shadow p-4 hover:shadow-md transition duration-200 cursor-pointer" data-id="">
            <div class="flex justify-between items-start mb-2">
                <h3 class="font-medium text-gray-800 truncate"></h3>
                <button class="text-gray-400 hover:text-yellow-500 note-star">
                    <i class="far fa-star"></i>
                </button>
            </div>
            <p class="text-gray-600 mb-3 whitespace-pre-wrap line-clamp-4"></p>
            <div class="flex justify-between items-center text-xs text-gray-500">
                <span class="px-2 py-1 rounded-full text-xs text-gray-800 font-medium note-tag-display"></span>
                <span class="note-last-edited"></span>
            </div>
        </div>
    </template>

    <div id="noteEditorModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl h-full md:max-h-[90vh] flex flex-col">
            <div class="px-6 py-4 border-b flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <select id="noteTag" class="text-xs rounded-full px-3 py-1 border focus:outline-none">
                        </select>
                    <button id="addCustomTagBtn" class="text-gray-500 hover:text-green-500 p-1 rounded-full" title="Add Custom Tag">
                        <i class="fas fa-plus text-xs"></i>
                    </button>
                    <span id="noteStatus" class="text-xs bg-gray-100 px-2 py-1 rounded">Private</span>
                </div>
                <div class="flex space-x-2">
                    <button id="togglePublicBtn" class="text-gray-500 hover:text-gray-700" title="Toggle Public/Private">
                        <i class="fas fa-globe"></i>
                    </button>
                    <button id="shareNoteBtn" class="text-gray-500 hover:text-gray-700" title="Share Note">
                        <i class="fas fa-user-plus"></i>
                    </button>
                    <button id="closeEditorBtn" class="text-gray-500 hover:text-gray-700" title="Close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="px-6 py-4 flex-1 overflow-y-auto relative" id="editorScrollContainer">
                <input type="text" id="noteTitle" placeholder="Title" class="w-full text-2xl font-bold mb-4 focus:outline-none">
                
                <div id="formattingToolbar" class="absolute hidden bg-white border border-gray-300 rounded-lg shadow-xl p-1 z-50 transform -translate-x-1/2 flex items-center space-x-1 whitespace-nowrap">
                    <button class="format-btn p-1 rounded hover:bg-gray-100 text-gray-700" data-command="bold" title="Bold"><i class="fas fa-bold"></i></button>
                    <button class="format-btn p-1 rounded hover:bg-gray-100 text-gray-700" data-command="italic" title="Italic"><i class="fas fa-italic"></i></button>
                    <button class="format-btn p-1 rounded hover:bg-gray-100 text-gray-700" data-command="underline" title="Underline"><i class="fas fa-underline"></i></button>
                    
                    <span class="mx-1 text-gray-300">|</span>
                    
                    <select id="fontSizeSelect" class="text-sm px-1 py-0.5 rounded border border-gray-200 focus:ring-0 focus:border-gray-400">
                        <option value="1">Small</option>
                        <option value="3" selected>Normal</option>
                        <option value="5">Large</option>
                        <option value="7">Huge</option>
                    </select>
                    
                    <input type="color" id="fontColorPicker" class="w-6 h-6 p-0 border-0 cursor-pointer align-middle" value="#000000" title="Font Color">
                </div>

                <div 
                    id="noteContentEditor" 
                    contenteditable="true" 
                    class="focus:outline-none" 
                    placeholder="Start writing..."
                ></div>
                <div id="collaboratorsSection" class="mt-6 border-t pt-4 hidden">
                    <h3 class="text-sm font-semibold text-gray-500 mb-2">Collaborators</h3>
                    <div class="flex flex-wrap gap-2">
                        <div class="flex items-center bg-gray-100 px-3 py-1 rounded-full">
                            <img src="https://randomuser.me/api/portraits/men/32.jpg" alt="User" class="w-6 h-6 rounded-full mr-2">
                            <span class="text-sm">John Doe</span>
                            <button class="ml-2 text-gray-400 hover:text-gray-600 remove-collaborator">
                                <i class="fas fa-times text-xs"></i>
                            </button>
                        </div>
                        <div class="relative">
                            <input type="text" placeholder="Add email..." class="text-sm px-3 py-1 border rounded-full focus:outline-none w-40">
                            <button class="absolute right-2 top-1.5 text-gray-400 hover:text-gray-600">
                                <i class="fas fa-plus text-xs"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="px-6 py-4 border-t flex justify-between items-center flex-wrap gap-3">
                <div class="text-xs text-gray-500">
                    Last edited: <span id="lastEdited">Just now</span>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="downloadPdfBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded-md transition duration-200 text-sm">
                        <i class="fas fa-file-pdf mr-1"></i> Download PDF
                    </button>

                    <button id="deleteNoteBtn" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1.5 rounded-md transition duration-200 text-sm">
                        <i class="fas fa-trash mr-1"></i> Trash
                    </button>
                    <div class="flex space-x-1">
                        <button class="attachment-btn p-2 rounded-full hover:bg-gray-100" data-type="image" title="Add Image">
                            <i class="fas fa-image text-gray-500 hover:text-blue-500"></i>
                        </button>
                        <button class="attachment-btn p-2 rounded-full hover:bg-gray-100" data-type="video" title="Add Video">
                            <i class="fas fa-video text-gray-500 hover:text-red-500"></i>
                        </button>
                        <button class="attachment-btn p-2 rounded-full hover:bg-gray-100" data-type="audio" title="Add Voice Note">
                            <i class="fas fa-microphone text-gray-500 hover:text-green-500"></i>
                        </button>
                        <button class="attachment-btn p-2 rounded-full hover:bg-gray-100" data-type="document" title="Add File">
                            <i class="fas fa-file-alt text-gray-500 hover:text-purple-500"></i>
                        </button>
                    </div>
                    <button id="saveNoteBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition duration-200">
                        Save
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="shareModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="px-6 py-4 border-b flex justify-between items-center">
                <h3 class="text-lg font-semibold">Share Note</h3>
                <button id="closeShareModalBtn" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="px-6 py-4">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Share with</label>
                    <div class="flex">
                        <input type="email" placeholder="Enter email" class="flex-1 px-3 py-2 border rounded-l focus:outline-none">
                        <button class="bg-green-500 text-white px-4 py-2 rounded-r hover:bg-green-600">Send</button>
                    </div>
                </div>
                <div class="border-t pt-4">
                    <h4 class="text-sm font-medium text-gray-700 mb-2">Shared with</h4>
                    <div class="space-y-2" id="sharedWithList">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <img src="https://randomuser.me/api/portraits/women/12.jpg" alt="User" class="w-8 h-8 rounded-full mr-2">
                                <span>jane.smith@example.com</span>
                            </div>
                            <select class="text-xs border rounded px-2 py-1 focus:outline-none">
                                <option>Can edit</option>
                                <option>Can view</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script>
        // Data et State Management
        let currentNote = null;
        let savedRange = null; // Variable pour sauvegarder la position du curseur
        let predefinedTags = ['work', 'personal', 'ideas', 'important', 'study']; // Tags pour la couleur/base
        let currentFilter = { type: 'all', value: null }; // { type: 'all', 'tag', 'starred', 'trash', value: 'tag-name' }
        let notes = [
            {
                id: 1,
                title: 'Plan de projet BNOTES (avec m√©dia)',
                content: 'D√©finir les fonctionnalit√©s cl√©s, cr√©er les maquettes et √©tablir le calendrier de d√©veloppement. Priorit√© : Authentification et CRUD de base.<p>Ici, un emplacement pour une image :</p>',
                tag: 'work',
                starred: true,
                public: false,
                lastEdited: '30 Nov 2025, 10:00 AM',
                deleted: false
            },
            {
                id: 2,
                title: 'Liste de courses',
                content: 'Lait, ≈ìufs, pain complet, √©pinards, poulet. N\'oubliez pas la nouvelle marque de caf√©!',
                tag: 'personal',
                starred: false,
                public: false,
                lastEdited: '30 Nov 2025, 1:00 PM',
                deleted: false
            },
            {
                id: 3,
                title: 'Id√©e de startup: Chatbot IA',
                content: "Un chatbot qui peut interagir de mani√®re fluide et g√©rer des t√¢ches complexes gr√¢ce √† l'int√©gration d'API multiples.",
                tag: 'ideas',
                starred: false,
                public: true,
                lastEdited: '29 Nov 2025, 9:00 AM',
                deleted: false
            },
            {
                id: 4,
                title: 'Nouvelle Recette',
                content: "Essayer cette recette de curry de l√©gumes avec du lait de coco.",
                tag: 'cuisine', // Custom tag
                starred: true,
                public: false,
                lastEdited: '29 Nov 2025, 9:00 AM',
                deleted: false
            },
        ];
        let viewMode = 'grid'; // 'grid' or 'list'

        // =========================================================
        // NOUVELLE LOGIQUE D'AUTHENTIFICATION FIREBASE
        // =========================================================
        
        // üö® ALERTE S√âCURIT√â CRITIQUE: Cette cl√© API est publiquement expos√©e.
        // Vous DEVEZ r√©voquer cette cl√© dans la console Google/Firebase et
        // la remplacer par une variable d'environnement (par exemple, dans un fichier .env non public)
        // ou la restreindre rigoureusement √† votre domaine (bnotes-243.firebaseapp.com).
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY", // CL√â API
            authDomain: "bnotes-243.firebaseapp.com", // DOMAINE D'AUTHENTIFICATION
            projectId: "bnotes-243", // ID DU PROJET
            storageBucket: "bnotes-243.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID", // ID DE L'EXP√âDITEUR
            appId: "YOUR_APP_ID" // ID DE L'APPLICATION
        };

        // Initialiser Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const FacebookProvider = new firebase.auth.FacebookAuthProvider();
        
        // Demander le nom d'utilisateur public et l'email (n√©cessaire pour l'authentification Facebook/Firebase)
        FacebookProvider.addScope('public_profile');
        // ‚úÖ FIX: Ajout du scope 'email' pour r√©soudre l'erreur "Invalid Scopes: email"
        FacebookProvider.addScope('email');
        
        /**
         * Met √† jour l'interface utilisateur en fonction de l'√©tat de l'utilisateur Firebase.
         * @param {firebase.User} user L'objet utilisateur de Firebase.
         */
        function updateUserUI(user) {
            const signInBtnContainer = document.getElementById('signInButton');
            const signedInContainer = document.getElementById('signedInContainer');
            const userPhoto = document.getElementById('userPhoto');
            const userNameEl = document.getElementById('userName');

            if (user) {
                // Utilisateur connect√©
                signInBtnContainer.classList.add('hidden');
                signedInContainer.classList.remove('hidden');
                // R√©cup√©rer les infos de l'utilisateur Facebook
                userNameEl.textContent = user.displayName || 'Utilisateur';
                userPhoto.src = user.photoURL || 'https://via.placeholder.com/40';
                showToast(`Connect√© en tant que ${user.displayName || 'Utilisateur'}!`);
            } else {
                // Utilisateur d√©connect√©
                signInBtnContainer.classList.remove('hidden');
                signedInContainer.classList.add('hidden');
            }
        }
        
        /**
         * G√®re la connexion avec Facebook via popup.
         */
        function handleFacebookSignIn() {
            auth.signInWithPopup(FacebookProvider)
                .then((result) => {
                    // La fonction updateUserUI (via onAuthStateChanged) s'occupera de l'affichage
                })
                .catch((error) => {
                    console.error("Erreur de connexion Facebook:", error);
                    let errorMessage = error.message;
                    // Tenter de rendre l'erreur plus lisible
                    if (error.code === 'auth/popup-closed-by-user') {
                        errorMessage = 'Connexion annul√©e par l\'utilisateur.';
                    } else if (error.code === 'auth/network-request-failed') {
                        errorMessage = '√âchec de la connexion r√©seau.';
                    } else if (error.code === 'auth/operation-not-allowed') {
                        errorMessage = 'Op√©ration non autoris√©e. V√©rifiez la configuration de Facebook dans la Console Firebase.';
                    }
                    showToast(`√âchec de la connexion: ${errorMessage}`, true);
                });
        }
        
        /**
         * G√®re la d√©connexion.
         */
        function handleSignOut(e) {
            e.preventDefault();
            auth.signOut()
                .then(() => {
                    showToast('D√©connect√©.');
                })
                .catch((error) => {
                    console.error("Erreur de d√©connexion:", error);
                    showToast(`√âchec de la d√©connexion: ${error.message}`, true);
                });
        }

        // =========================================================
        // FIN LOGIQUE AUTHENTIFICATION
        // =========================================================


        // --- Utility Functions pour la gestion du curseur et des tags ---

        /**
         * Sauvegarde la position actuelle du curseur (la s√©lection).
         */
        function saveSelection() {
            const editor = document.getElementById('noteContentEditor');
            const selection = window.getSelection();
            if (selection.rangeCount > 0 && editor.contains(selection.getRangeAt(0).commonAncestorContainer)) {
                // Cr√©er une copie du Range et le sauvegarder
                savedRange = selection.getRangeAt(0).cloneRange(); 
            }
        }
        
        /**
         * G√®re la s√©lection dans l'√©diteur : sauvegarde et affiche la barre d'outils.
         */
        function handleEditorSelection() {
            saveSelection();
            showToolbar();
        }

        /**
         * Restaure la position du curseur sauvegard√©e.
         */
        function restoreSelection() {
            if (savedRange) {
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.add(savedRange);
                // S'assurer que l'√©diteur a le focus apr√®s la restauration
                document.getElementById('noteContentEditor').focus(); 
            }
        }

        /**
         * Formate la taille du fichier.
         * @param {number} bytes 
         */
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        /**
         * Met √† jour la classe du tag et son texte dans une carte de note.
         */
        function updateNoteCardTag(noteCard, note) {
            const tagEl = noteCard.querySelector('.note-tag-display');
            // R√©initialiser les classes de tag pour √©viter les conflits de couleur
            tagEl.className = 'px-2 py-1 rounded-full text-xs text-gray-800 font-medium note-tag-display'; 
            
            // Si le tag est un tag "pr√©-styl√©" ou un tag personnalis√©
            const tagClass = `tag-${note.tag.toLowerCase().replace(/[^a-z0-9]/g, '-')}`; 
            
            // Ajouter la classe bas√©e sur le tag pour la couleur
            tagEl.classList.add(tagClass);
            tagEl.textContent = note.tag.charAt(0).toUpperCase() + note.tag.slice(1);
        }

        /**
         * Extrait tous les tags uniques des notes, y compris les tags personnalis√©s.
         * Met √† jour predefinedTags si des tags custom sont trouv√©s dans les notes.
         * @returns {Array<string>} Liste unique et tri√©e des tags.
         */
        function getAllTags() {
            let allTags = new Set(predefinedTags); 

            notes.forEach(note => {
                if (note.tag) {
                    allTags.add(note.tag);
                }
            });

            // Mettre √† jour predefinedTags avec tous les tags uniques pour une gestion simple
            // Assurez-vous que la liste est un tableau unique et tri√©
            predefinedTags = Array.from(allTags).filter(tag => tag && tag.trim() !== '').map(tag => tag.toLowerCase()).sort();
            
            return predefinedTags;
        }

        /**
         * Rend les liens de tags dans la barre lat√©rale.
         */
        function renderSidebarTags() {
            const tagsList = document.getElementById('tagsList');
            tagsList.innerHTML = '';
            
            const allUniqueTags = getAllTags();

            allUniqueTags.forEach(tag => {
                let colorClass = '';
                // Utiliser des couleurs bas√©es sur les classes CSS pr√©d√©finies si disponibles
                switch(tag.toLowerCase()) {
                    case 'work': colorClass = 'bg-yellow-500'; break;
                    case 'personal': colorClass = 'bg-green-500'; break;
                    case 'ideas': colorClass = 'bg-blue-500'; break;
                    case 'important': colorClass = 'bg-red-500'; break;
                    case 'study': colorClass = 'bg-purple-500'; break;
                    default: colorClass = 'bg-gray-500'; // Couleur par d√©faut pour les tags personnalis√©s
                }

                const tagDisplayName = tag.charAt(0).toUpperCase() + tag.slice(1);
                
                const link = document.createElement('a');
                link.href = `#tag/${tag}`;
                link.className = `tag-link flex items-center px-3 py-2 text-gray-700 rounded-lg hover:bg-gray-100`;
                link.setAttribute('data-tag', tag);
                link.innerHTML = `<span class="w-3 h-3 rounded-full ${colorClass} mr-3"></span> ${tagDisplayName}`;
                
                // Add active state if this tag is the current filter
                if (currentFilter.type === 'tag' && currentFilter.value === tag) {
                    // Supprimer l'√©tat actif des liens principaux
                    document.querySelectorAll('aside a.sidebar-link').forEach(l => l.classList.remove('bg-gray-100'));
                    link.classList.add('bg-gray-100');
                }

                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    filterNotesByTag(tag);
                });

                tagsList.appendChild(link);
            });
        }

        /**
         * D√©finit le filtre par tag, met √† jour la barre lat√©rale et re-rend les notes.
         * @param {string} tag Le tag par lequel filtrer.
         */
        function filterNotesByTag(tag) {
            currentFilter = { type: 'tag', value: tag };
            
            // 1. Mettre √† jour l'√©tat actif des liens principaux
            document.querySelectorAll('aside a.sidebar-link').forEach(l => l.classList.remove('bg-gray-100'));

            // 2. Re-rendre les tags (pour mettre en √©vidence le tag actif)
            renderSidebarTags();
            
            // 3. Re-rendre les notes
            renderNotes();
            showToast(`Filtering by tag: ${tag.charAt(0).toUpperCase() + tag.slice(1)}`);
        }
        
        /**
         * G√®re l'ajout d'un nouveau tag personnalis√©.
         */
        function handleAddNewTag() {
            const newTagName = prompt("Enter the name for the new custom tag:");
            
            if (newTagName && newTagName.trim() !== '') {
                const cleanTagName = newTagName.trim().toLowerCase();
                
                // V√©rifier si le tag existe d√©j√† (case-insensitive)
                if (getAllTags().includes(cleanTagName)) {
                    showToast(`Tag "${newTagName}" already exists.`);
                    return;
                }

                // 1. Ajouter le nouveau tag √† la liste principale (predefinedTags est mis √† jour par getAllTags)
                predefinedTags.push(cleanTagName);
                predefinedTags.sort(); 

                // 2. Mettre √† jour la liste d√©roulante du modal
                const tagSelect = document.getElementById('noteTag');
                tagSelect.innerHTML = getAllTags().map(tag => {
                    const displayName = tag.charAt(0).toUpperCase() + tag.slice(1);
                    return `<option value="${tag}" ${tag === cleanTagName ? 'selected' : ''}>${displayName}</option>`;
                }).join('');
                tagSelect.value = cleanTagName;
                
                // 3. Appliquer ce tag √† la note courante
                if (currentNote) {
                    currentNote.tag = cleanTagName;
                }

                // 4. Mettre √† jour la barre lat√©rale
                renderSidebarTags();
                
                showToast(`Custom tag "${newTagName}" added and selected.`);
            }
        }


        // --- Toolbar Functions ---
        
        /**
         * Executes a formatting command on the current selection.
         * Uses execCommand for simplicity in contenteditable.
         * @param {string} command The execCommand command (e.g., 'bold', 'foreColor', 'fontSize').
         * @param {string|number} value The value for the command (e.g., 'red', '3').
         */
        function applyFormat(command, value = null) {
            // Use the core execCommand for formatting
            document.execCommand(command, false, value);

            // After formatting, hide the toolbar
            hideToolbar();
            
            // Ensure the focus remains on the editor or is restored
            document.getElementById('noteContentEditor').focus();
            saveSelection(); // Resave the selection after formatting
        }
        
        /**
         * Shows and positions the formatting toolbar near the current selection.
         */
        function showToolbar() {
            const editor = document.getElementById('noteContentEditor');
            const toolbar = document.getElementById('formattingToolbar');
            const selection = window.getSelection();

            // V√©rifie s'il y a du texte s√©lectionn√© et si la s√©lection est √† l'int√©rieur de l'√©diteur
            if (!selection.isCollapsed && editor.contains(selection.anchorNode)) {
                // Obtient le rectangle englobant de la s√©lection
                const range = selection.getRangeAt(0);
                const rect = range.getBoundingClientRect();
                
                // Obtient le rectangle englobant du conteneur parent d√©filable
                const scrollContainer = document.getElementById('editorScrollContainer');
                const scrollContainerRect = scrollContainer.getBoundingClientRect();
                
                // Calcul de la position X relative au scrollContainer: centre de la s√©lection
                // - scrollContainerRect.left d√©place la position relative au d√©but du conteneur.
                const x = rect.left + (rect.width / 2) - scrollContainerRect.left;
                
                // Calcul de la position Y relative au scrollContainer: au-dessus de la s√©lection
                // rect.top - scrollContainerRect.top : position relative sans le scroll.
                // + scrollContainer.scrollTop : ajustement pour le d√©filement.
                const toolbarHeight = 40; 
                const y = rect.top - scrollContainerRect.top + scrollContainer.scrollTop - toolbarHeight - 5; // -5px de marge
                
                // Positionne et affiche la barre d'outils
                toolbar.style.left = `${x}px`;
                toolbar.style.top = `${y}px`; 
                
                toolbar.classList.remove('hidden');

            } else {
                hideToolbar();
            }
        }

        /**
         * Hides the formatting toolbar.
         */
        function hideToolbar() {
            document.getElementById('formattingToolbar').classList.add('hidden');
        }

        // --- Notes Management ---

        /**
         * D√©termine le titre de la page en fonction du filtre actuel.
         */
        function getCurrentPageTitle() {
            switch (currentFilter.type) {
                case 'all': return 'My Notes';
                case 'starred': return 'Starred Notes';
                case 'trash': return 'Trash';
                case 'shared': return 'Shared with me';
                case 'public': return 'Public Notes';
                case 'tag': 
                    const tagName = currentFilter.value.charAt(0).toUpperCase() + currentFilter.value.slice(1);
                    return `${tagName} Notes`;
                default: return 'My Notes';
            }
        }


        /**
         * Rend toutes les notes actives dans la grille, en appliquant le filtre actuel.
         */
        function renderNotes() {
            const grid = document.getElementById('notesGrid');
            grid.innerHTML = '';
            
            document.getElementById('pageTitle').textContent = getCurrentPageTitle();

            let filteredNotes = notes;

            // 1. Filtrer par √©tat (Deleted)
            filteredNotes = filteredNotes.filter(note => {
                if (currentFilter.type === 'trash') {
                    return note.deleted;
                } else {
                    return !note.deleted; // N'affiche que les notes actives (non supprim√©es) pour les autres vues
                }
            });

            // 2. Appliquer les filtres sp√©cifiques
            if (currentFilter.type === 'tag' && currentFilter.value) {
                filteredNotes = filteredNotes.filter(note => note.tag === currentFilter.value);
            } else if (currentFilter.type === 'starred') {
                filteredNotes = filteredNotes.filter(note => note.starred);
            }
            
            // Note: 'shared' and 'public' filters are not fully implemented in the mock data,
            // but the logic for 'all', 'tag', 'starred', and 'trash' is solid.

            filteredNotes.forEach(note => {
                const template = document.getElementById('noteTemplate');
                const clone = template.content.cloneNode(true);
                const noteCard = clone.querySelector('.note-card');
                
                noteCard.setAttribute('data-id', note.id);
                noteCard.querySelector('h3').textContent = note.title || 'Untitled Note';
                
                // R√©cup√®re un aper√ßu du contenu (texte seulement, ignore les balises HTML/m√©dia)
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = note.content;
                const contentPreview = tempDiv.textContent;

                noteCard.querySelector('p').textContent = contentPreview.substring(0, 150) + (contentPreview.length > 150 ? '...' : '');
                
                noteCard.querySelector('.note-last-edited').textContent = note.lastEdited;

                // Tag and Star
                updateNoteCardTag(noteCard, note);
                const starIcon = noteCard.querySelector('.note-star i');
                if (note.starred) {
                    starIcon.classList.replace('far', 'fas');
                    starIcon.classList.add('text-yellow-500');
                } else {
                    starIcon.classList.replace('fas', 'far');
                    starIcon.classList.remove('text-yellow-500');
                }
                
                // Event Listeners
                noteCard.addEventListener('click', () => openEditor(note));
                noteCard.querySelector('.note-star').addEventListener('click', function(e) {
                    e.stopPropagation();
                    toggleStar(this, note);
                });
                
                grid.appendChild(noteCard);
            });
            setViewMode(viewMode);
        }

        /**
         * Cr√©e une nouvelle note.
         */
        function createNewNote(e) {
            e.preventDefault();
            const newNote = {
                id: Date.now(),
                title: 'New Note',
                content: 'Start writing here...',
                tag: 'work',
                starred: false,
                public: false,
                lastEdited: new Date().toLocaleString(),
                deleted: false
            };
            
            notes.unshift(newNote);
            currentNote = newNote;
            
            // R√©initialiser le filtre pour montrer la nouvelle note
            currentFilter = { type: 'all', value: null };
            document.querySelectorAll('aside a.sidebar-link').forEach(l => l.classList.remove('bg-gray-100'));
            document.querySelector('.sidebar-link[data-filter="all"]').classList.add('bg-gray-100');

            renderSidebarTags();
            renderNotes();
            openEditor(newNote);
            
            setTimeout(() => {
                document.getElementById('noteTitle').focus();
            }, 100);
        }

        /**
         * Sauvegarde la note actuellement ouverte.
         */
        function saveNote() {
            if (!currentNote) return;
            
            const newTag = document.getElementById('noteTag').value;

            currentNote.title = document.getElementById('noteTitle').value || 'Untitled Note';
            // Utilise innerHTML pour capturer le contenu riche (texte + balises m√©dia)
            currentNote.content = document.getElementById('noteContentEditor').innerHTML;
            currentNote.tag = newTag;
            currentNote.lastEdited = new Date().toLocaleString();
            
            // S'assurer que la barre lat√©rale est √† jour si un nouveau tag a √©t√© utilis√©
            getAllTags(); 
            renderSidebarTags(); 

            renderNotes(); // Mettre √† jour la grille
            closeEditor();
            
            showToast('Note saved successfully!');
        }

        /**
         * D√©place la note vers la corbeille.
         */
        function deleteNote() {
            if (!currentNote) return;
            
            currentNote.deleted = true;
            currentNote.deletedAt = new Date().toISOString();
            
            const noteCard = document.querySelector(`[data-id="${currentNote.id}"]`);
            if (noteCard) noteCard.remove(); 

            closeEditor();
            showToast('Note moved to trash');
            renderNotes(); 
        }

        /**
         * Bascule le statut public/priv√© de la note.
         */
        function togglePublic() {
            if (!currentNote) return;
            currentNote.public = !currentNote.public;
            document.getElementById('noteStatus').textContent = currentNote.public ? 'Public' : 'Private';
            showToast(`Note set to ${currentNote.public ? 'Public' : 'Private'}`);
        }

        /**
         * Bascule l'√©toile (starred) de la note.
         */
        function toggleStar(starBtn, note) {
            const icon = starBtn.querySelector('i');
            note.starred = !note.starred;
            if (note.starred) {
                icon.classList.replace('far', 'fas');
                icon.classList.add('text-yellow-500');
                showToast('Note starred!');
            } else {
                icon.classList.replace('fas', 'far');
                icon.classList.remove('text-yellow-500');
                showToast('Note unstarred!');
            }
            // Mettre √† jour la vue si on est dans le filtre "Starred"
            if (currentFilter.type === 'starred') {
                 renderNotes();
            }
        }

        // --- Editor Modal ---

        /**
         * Ouvre le modal de l'√©diteur.
         * @param {object} note L'objet note √† √©diter.
         */
        function openEditor(note) {
            currentNote = note;
            const editor = document.getElementById('noteContentEditor');
            const tagSelect = document.getElementById('noteTag');
            
            document.getElementById('noteTitle').value = note.title;
            editor.innerHTML = note.content; // Charge le contenu riche (HTML)
            
            // Remplir le select de tags avec tous les tags uniques (y compris ceux de cette note)
            tagSelect.innerHTML = getAllTags().map(tag => {
                const displayName = tag.charAt(0).toUpperCase() + tag.slice(1);
                return `<option value="${tag}" ${note.tag === tag ? 'selected' : ''}>${displayName}</option>`;
            }).join('');
            
            tagSelect.value = note.tag; // S'assurer que le bon tag est s√©lectionn√©
            
            document.getElementById('noteStatus').textContent = note.public ? 'Public' : 'Private';
            document.getElementById('lastEdited').textContent = note.lastEdited;
            document.getElementById('noteEditorModal').classList.remove('hidden');
            
            document.getElementById('collaboratorsSection').classList.add('hidden');

            // Ajout des listeners pour la gestion du curseur et de la barre d'outils
            editor.addEventListener('mouseup', handleEditorSelection);
            editor.addEventListener('keyup', handleEditorSelection);
            editor.focus();
            
            // Initialisation de la s√©lection au chargement (curseur √† la fin)
            setTimeout(() => {
                const range = document.createRange();
                range.selectNodeContents(editor);
                range.collapse(false); // Curseur √† la fin
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.add(range);
                saveSelection();
            }, 50);
        }
        
        /**
         * Ferme le modal de l'√©diteur.
         */
        function closeEditor() {
            document.getElementById('noteEditorModal').classList.add('hidden');
            document.getElementById('noteContentEditor').removeEventListener('mouseup', handleEditorSelection);
            document.getElementById('noteContentEditor').removeEventListener('keyup', handleEditorSelection);
            hideToolbar();
            currentNote = null;
            savedRange = null;
        }

        // --- Attachments (Mise √† jour pour l'insertion au curseur plus robuste) ---

        /**
         * G√®re la s√©lection des fichiers et l'insertion dans le contenu au curseur.
         * @param {string} type Le type d'attachement.
         */
        function handleAttachment(type) {
            if (!currentNote) return;
            
            // Si savedRange n'est pas d√©fini, l'utilisateur n'a pas plac√© le curseur
            if (!savedRange) {
                showToast("Veuillez cliquer dans l'√©diteur de notes pour placer le curseur.");
                return;
            }

            const input = document.createElement('input');
            input.type = 'file';
            
            switch(type) {
                case 'image': input.accept = 'image/*'; break;
                case 'video': input.accept = 'video/*'; break;
                case 'audio': input.accept = 'audio/*'; break;
                case 'document': input.accept = '.pdf,.doc,.docx,.txt,.xls,.xlsx,.ppt,.pptx'; break;
                default: input.accept = '*';
            }
            
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    const dataURL = event.target.result;
                    let htmlToInsert = '';
                    const fileName = file.name;

                    // Cr√©ation de l'√©l√©ment HTML √† ins√©rer
                    switch (type) {
                        case 'image':
                            // Encapsul√© dans <p> pour une meilleure mise en page et un saut de ligne
                            htmlToInsert = `<p><img src="${dataURL}" alt="${fileName}" style="max-width:100%; height:auto; display:block;" title="${fileName}"></p>`;
                            break;
                        case 'video':
                            htmlToInsert = `<p><video controls style="max-width:100%; height:auto; display:block;"><source src="${dataURL}" type="${file.type}"></video></p>`;
                            break;
                        case 'audio':
                            htmlToInsert = `<p><audio controls src="${dataURL}" style="width:100%;"></audio></p>`;
                            break;
                        case 'document':
                            // Pour les documents, nous ins√©rons un lien hypertexte avec un style
                            htmlToInsert = `<p class="bg-gray-100 p-2 rounded-md"><i class="fas fa-file-alt text-purple-500 mr-2"></i> Document: <a href="${dataURL}" download="${fileName}" target="_blank" style="text-decoration:underline; color:#3b82f6;">${fileName} (${formatFileSize(file.size)})</a></p>`;
                            break;
                        default:
                            return;
                    }

                    // *** LOGIQUE D'INSERTION ROBUSTE UTILISANT L'API RANGE ***
                    
                    // 1. Cr√©er un DocumentFragment √† partir de notre HTML
                    const fragment = savedRange.createContextualFragment(htmlToInsert);
                    
                    // 2. R√©cup√©rer le dernier n≈ìud ins√©r√© (pour positionner le curseur)
                    const lastNode = fragment.lastChild; 
                    
                    // 3. Supprimer le contenu actuel de la s√©lection et ins√©rer le nouveau contenu
                    savedRange.deleteContents();
                    savedRange.insertNode(fragment);
                    
                    // 4. Mettre √† jour la position du curseur (juste apr√®s le dernier n≈ìud ins√©r√©)
                    if (lastNode) {
                        // Positionner le curseur juste apr√®s le dernier n≈ìud ins√©r√©
                        savedRange.setStartAfter(lastNode);
                    }
                    savedRange.collapse(false); // S'assurer que la fin est la position du curseur
                    
                    // 5. Appliquer la nouvelle plage √† la s√©lection du navigateur
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.add(savedRange);
                    
                    // 6. S'assurer que l'√©diteur a le focus apr√®s l'insertion
                    document.getElementById('noteContentEditor').focus();

                    showToast(`${fileName} inserted at cursor!`);
                };
                reader.readAsDataURL(file);
            };
            
            // D√©clenche l'ouverture de la bo√Æte de dialogue de s√©lection de fichier
            input.click();
        }


        /**
         * T√©l√©charge la note actuelle au format PDF.
         * Utilise html2canvas pour convertir le contenu HTML en image, puis jsPDF pour cr√©er le fichier.
         */
        function downloadNoteAsPDF() {
            if (!currentNote) return;

            const title = currentNote.title || 'Untitled Note';
            const contentElement = document.getElementById('noteContentEditor');

            showToast('Generating PDF...');

            // Utiliser html2canvas pour rendre le contenu HTML en image
            html2canvas(contentElement, {
                scale: 2, // Am√©liore la qualit√© (2x)
                useCORS: true // N√©cessaire si des images externes sont utilis√©es
            }).then(canvas => {
                const { jsPDF } = window.jspdf;
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4'); // 'p' for portrait, 'mm' for millimeters, 'a4' size
                
                const imgWidth = 210; // A4 width in mm
                const pageHeight = 297; // A4 height in mm
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                // 1. Ajouter le titre de la note en haut
                pdf.setFontSize(24);
                pdf.text(title, 10, 20); // x=10, y=20 (mm)

                // Ajouter une ligne de s√©paration
                pdf.setLineWidth(0.5);
                pdf.line(10, 25, 200, 25); 

                // D√©finir la position de d√©part de l'image du contenu
                position = 30; // 30mm apr√®s le titre/s√©parateur
                
                // 2. Ajouter l'image du contenu
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= (pageHeight - position); // Combien il reste apr√®s la premi√®re page

                // G√©rer le contenu sur plusieurs pages
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                // 3. Sauvegarder le fichier
                pdf.save(`${title}.pdf`);
                showToast('PDF downloaded!');
            }).catch(error => {
                console.error("PDF generation failed:", error);
                showToast("Failed to generate PDF. Check console for details.", true);
            });
        }

        // --- View & Sidebar ---

        /**
         * Change le mode d'affichage des notes ('grid' ou 'list').
         */
        function setViewMode(mode) {
            viewMode = mode;
            const grid = document.getElementById('notesGrid');
            const gridBtn = document.getElementById('gridViewBtn');
            const listBtn = document.getElementById('listViewBtn');

            // Mettre √† jour les classes de grille
            grid.classList.remove('grid-cols-1', 'sm:grid-cols-2', 'lg:grid-cols-3', 'xl:grid-cols-4');
            if (mode === 'grid') {
                grid.classList.add('grid-cols-1', 'sm:grid-cols-2', 'lg:grid-cols-3', 'xl:grid-cols-4');
                gridBtn.classList.add('bg-gray-200');
                listBtn.classList.remove('bg-gray-200');
            } else { // list view
                grid.classList.add('grid-cols-1');
                listBtn.classList.add('bg-gray-200');
                gridBtn.classList.remove('bg-gray-200');
            }
        }

        /**
         * Fonction pour g√©rer les liens de la barre lat√©rale (All Notes, Starred, Trash, etc.).
         */
        function handleSidebarLink(e) {
            e.preventDefault();
            const filterType = this.getAttribute('data-filter');

            // 1. Mettre √† jour l'√©tat du filtre
            currentFilter = { type: filterType, value: null };
            
            // 2. Mettre √† jour l'√©tat actif des liens principaux
            document.querySelectorAll('aside a.sidebar-link').forEach(l => l.classList.remove('bg-gray-100'));
            this.classList.add('bg-gray-100');
            
            // 3. R√©initialiser l'√©tat actif des tags
            renderSidebarTags();
            
            // 4. Re-rendre les notes avec le nouveau filtre
            renderNotes(); 
            
            showToast(`Viewing ${filterType.charAt(0).toUpperCase() + filterType.slice(1)}`);
        }

        // --- Share Modal ---

        function openShareModal() {
            document.getElementById('shareModal').classList.remove('hidden');
            document.getElementById('collaboratorsSection').classList.remove('hidden'); 
        }
        
        function closeShareModal() {
            document.getElementById('shareModal').classList.add('hidden');
        }

        // --- Toast Notification ---

        function showToast(message, isError = false) {
            const toast = document.createElement('div');
            const colorClass = isError ? 'bg-red-600' : 'bg-gray-800';
            toast.className = `fixed bottom-4 right-4 ${colorClass} text-white px-4 py-2 rounded-lg shadow-xl opacity-0 transition-opacity duration-300 z-50`;
            toast.textContent = message;
            document.body.appendChild(toast);

            // Fade in
            setTimeout(() => {
                toast.classList.remove('opacity-0');
            }, 10);

            // Fade out and remove
            setTimeout(() => {
                toast.classList.add('opacity-0');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        }

        // --- Initialization and Event Listeners ---

        document.addEventListener('DOMContentLoaded', () => {
            
            // L'√©couteur d'√©tat de Firebase met √† jour l'UI d√®s que l'√©tat d'auth change
            auth.onAuthStateChanged(updateUserUI);
            
            renderSidebarTags(); 
            renderNotes();

            // Note Editor Modal Controls
            document.getElementById('createNoteBtn').addEventListener('click', createNewNote);
            document.getElementById('closeEditorBtn').addEventListener('click', closeEditor);
            document.getElementById('saveNoteBtn').addEventListener('click', saveNote);
            document.getElementById('deleteNoteBtn').addEventListener('click', deleteNote);
            document.getElementById('togglePublicBtn').addEventListener('click', togglePublic);
            document.getElementById('shareNoteBtn').addEventListener('click', openShareModal);
            document.getElementById('downloadPdfBtn').addEventListener('click', downloadNoteAsPDF);
            
            // View Toggle Buttons
            document.getElementById('gridViewBtn').addEventListener('click', () => setViewMode('grid'));
            document.getElementById('listViewBtn').addEventListener('click', () => setViewMode('list'));

            // Sidebar Links (All Notes, Starred, Trash, etc.)
            document.querySelectorAll('aside a.sidebar-link').forEach(link => {
                link.addEventListener('click', handleSidebarLink);
            });
            
            // Share Modal Controls
            document.getElementById('closeShareModalBtn').addEventListener('click', closeShareModal);
            
            // --- New Tag Customization Listener ---
            document.getElementById('addCustomTagBtn').addEventListener('click', function(e) {
                e.preventDefault();
                handleAddNewTag();
            });

            // Sauvegarde du curseur AVANT l'ouverture de la bo√Æte de dialogue de fichier
            document.querySelectorAll('.attachment-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    // 1. Sauvegarde la position du curseur imm√©diatement
                    saveSelection(); 
                    const type = this.getAttribute('data-type');
                    // 2. D√©clenche le processus de s√©lection/insertion
                    handleAttachment(type);
                });
            });

            // --- Toolbar Listeners ---
            document.querySelectorAll('#formattingToolbar .format-btn').forEach(button => {
                button.addEventListener('mousedown', function(e) {
                    e.preventDefault(); // TR√àS IMPORTANT: Emp√™che l'√©diteur de perdre le focus
                    const command = this.getAttribute('data-command');
                    applyFormat(command);
                });
            });

            document.getElementById('fontSizeSelect').addEventListener('change', function(e) {
                e.preventDefault();
                applyFormat('fontSize', this.value);
            });

            document.getElementById('fontColorPicker').addEventListener('input', function(e) {
                e.preventDefault();
                applyFormat('foreColor', this.value);
            });
            
            // Pour cacher la barre d'outils si l'utilisateur clique en dehors sans s√©lection
            document.getElementById('editorScrollContainer').addEventListener('mousedown', function(e) {
                const editor = document.getElementById('noteContentEditor');
                const toolbar = document.getElementById('formattingToolbar');
                // Si le clic n'est pas sur la barre d'outils, on la masque (sauf si c'est l'√©diteur lui-m√™me)
                if (!toolbar.contains(e.target) && !editor.contains(e.target) && window.getSelection().isCollapsed) {
                    hideToolbar();
                }
            });


            // MISE √Ä JOUR : Remplacement de la logique mock par les fonctions Firebase
            document.getElementById('signInButton').addEventListener('click', handleFacebookSignIn);
            document.getElementById('signOutButton').addEventListener('click', handleSignOut);

            // Initial active link (All Notes)
            document.querySelector('.sidebar-link[data-filter="all"]').classList.add('bg-gray-100');
        });
    </script>
</body>
</html>
